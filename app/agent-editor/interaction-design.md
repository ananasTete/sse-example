# 编辑器 + Chatbot 联动交互设计（完整版）

---

## 一、核心概念

| 概念         | 说明                                                |
| ------------ | --------------------------------------------------- |
| **全文模式** | 默认状态，对话上下文为编辑器全文                    |
| **选中模式** | 用户选中文字并点击 chatbot 后激活，上下文为选中内容 |
| **建议**     | AI 返回的可应用修改，有生命周期                     |

---

## 二、状态机

```
┌─────────────┐                              ┌─────────────┐
│             │   选中文字 + 点击 chatbot      │             │
│  全文模式    │  ─────────────────────────→   │  选中模式   │
│  (默认)      │  ←─────────────────────────  │  (高亮激活) │
│             │   点击编辑器任意位置            │             │
└─────────────┘                              └─────────────┘
```

---

## 三、选区激活逻辑

```
用户在编辑器中选中文字 "███"
         │
         ├─→ 下一步点击编辑器其他位置
         │       └─→ 选区正常消失（浏览器默认行为）
         │
         └─→ 下一步点击 chatbot 区域
                 └─→ 触发 Decoration 装饰器
                     └─→ 选中文字添加背景高亮
                     └─→ 进入「选中模式」
                             │
                             ├─→ 点击编辑器任意位置
                             │       └─→ 高亮消失，回到「全文模式」
                             │
                             └─→ 在 chatbot 发送消息
                                     └─→ 高亮保持，开始选中模式对话
```

---

## 四、UI 布局

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│   ┌─────────────────────────┐   ┌───────────────────────────┐ │
│   │                         │   │                           │ │
│   │      Tiptap 编辑器       │   │        Chatbot            │ │
│   │                         │   │                           │ │
│   │   用户正在写作...         │   │   [对话历史区域]            │  │
│   │                         │   │                           │ │
│   │   这里有一段 ████ 被      │   │   AI: ...                 │ │
│   │   高亮的文字             │   │   User: ...                │ │
│   │                         │   │                           │ │
│   │                         │   ├───────────────────────────┤ │
│   │                         │   │ [上下文提示条 - 选中模式]    │ │
│   │                         │   ├───────────────────────────┤ │
│   │                         │   │ [输入框]          [发送]    │ │
│   └─────────────────────────┘   └───────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 五、Chatbot 输入区域

### 全文模式

```
┌─────────────────────────────────────┐
│  请输入...                   [发送]   │
└─────────────────────────────────────┘
```

### 选中模式

```
┌─────────────────────────────────────┐
│  正在讨论："这里是选中的文字..."         │
│  [优化] [续写] [扩写] [解释]    [×]    │
├─────────────────────────────────────┤
│  请输入...                   [发送]   │
└─────────────────────────────────────┘
```

**提示条说明：**

- 显示截断的选中内容（如超过 20 字则 `...` 截断）
- 快捷按钮点击后直接发送预设 prompt
- `[×]` 按钮点击后取消高亮，回到全文模式

---

## 六、AI 建议输出格式

### 选中模式 — 多个改写方案

```
┌─────────────────────────────────────────────────┐
│ AI: 这里有 3 个方案供你选择：                       │
│                                                 │
│ ┌─ 方案 1：更简洁 ─────────────────────────┐      │
│ │ "优化后的文字内容..."                     │      │
│ │                          [应用] [复制]   │     │
│ └──────────────────────────────────────────┘    │
│                                                 │
│ ┌─ 方案 2：更正式 ─────────────────────────┐      │
│ │ "优化后的文字内容..."                    │       │
│ │                          [应用] [复制]   │     │
│ └──────────────────────────────────────────┘    │
│                                                 │
│ ┌─ 方案 3：更生动 ─────────────────────────┐      │
│ │ "优化后的文字内容..."                     │      │
│ │                          [应用] [复制]   │      │
│ └──────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
```

### 全文模式 — 多处编辑建议

```
┌─────────────────────────────────────────────────┐
│ AI: 我建议对以下 3 处进行修改：                     │
│                                                 │
│ ┌─ 第 1 处（第 2 段）─────────────────────┐       │
│ │ - 这里是原文内容                        │       │
│ │ + 这里是修改后内容                       │       │
│ │                          [应用] [定位]  │      │
│ └─────────────────────────────────────────┘    │
│                                                │
│ ┌─ 第 2 处（第 5 段）─────────────────────┐      │
│ │ - 这里是原文内容                        │       │
│ │ + 这里是修改后内容                       │      │
│ │                          [应用] [定位]  │      │
│ └─────────────────────────────────────────┘    │
│                                                │
│ [全部应用]                                       │
└─────────────────────────────────────────────────┘
```

**按钮说明：**

- `[应用]` — 将修改写入编辑器对应位置
- `[复制]` — 复制内容到剪贴板
- `[定位]` — 滚动编辑器到该位置并高亮闪烁提示

---

## 七、建议生命周期

```
        ┌──────────────────┐
        │   AI 生成建议    │
        │   状态：可用     │
        └────────┬─────────┘
                 │
     ┌───────────┼───────────┬────────────────┐
     │           │           │                │
     ▼           ▼           ▼                ▼
 用户应用    用户发送     高亮消失        用户点击
 其中一个    新消息      (点击编辑器)     [×] 按钮
     │           │           │                │
     ▼           ▼           ▼                ▼
┌─────────┐ ┌─────────┐ ┌─────────┐    ┌─────────┐
│该条:已用  │ │全部失效 │  │全部失效  │    │全部失效 │
│其他:失效  │ │        │ │         │    │         │
└─────────┘ └─────────┘ └─────────┘    └─────────┘
```

### 状态 UI 对照

| 状态   | [应用] 按钮     | [复制] 按钮 | 卡片样式 |
| ------ | --------------- | ----------- | -------- |
| 可用   | 可点击          | 可点击      | 正常     |
| 已应用 | 显示 `✓ 已应用` | 可点击      | 绿色边框 |
| 失效   | 置灰不可点击    | 可点击      | 整体置灰 |

---

## 八、应用修改流程

```
用户点击 [应用]
      │
      ▼
┌─────────────────────────┐
│ 检查：高亮是否仍存在？      │
└───────────┬─────────────┘
            │
    ┌───────┴───────┐
    │               │
    ▼               ▼
  存在            不存在
    │               │
    ▼               ▼
 执行替换      按钮已置灰
    │          (不可能到达)
    ▼
 标记该建议为「已应用」
    │
    ▼
 其他建议标记为「失效」
    │
    ▼
 编辑器记录操作到 undo 栈
 (支持 Ctrl+Z 撤销)
```

---

## 九、对话历史处理

- 切换选区时，历史对话**保留**
- 新消息会标注当时的上下文模式：

```
┌─────────────────────────────────────┐
│ [全文] User: 帮我检查全文的语法         │
│        AI: 我发现以下问题...          │
│                                     │
│ [选中] User: 优化这段话                │  ← 标注为选中模式
│        AI: 这里有 3 个方案...         │
│                                     │
│ [全文] User: 再帮我写个结尾            │
│        AI: ...                      │
└─────────────────────────────────────┘
```

---

## 十、快捷键支持（可选）

| 快捷键             | 作用                           |
| ------------------ | ------------------------------ |
| `Ctrl+Z` / `Cmd+Z` | 撤销 AI 修改                   |
| `Escape`           | 取消当前选中模式，回到全文模式 |
| `Ctrl+Enter`       | 发送消息                       |

---

## 十一、边界情况处理

| 场景                     | 处理方式                                               |
| ------------------------ | ------------------------------------------------------ |
| 选中内容为空（光标闪烁） | 不触发选中模式，保持全文模式                           |
| 选中内容跨多个段落       | 正常支持，高亮整个选区                                 |
| 编辑器内容为空           | 全文模式下提示「编辑器为空，请先输入内容」             |
| AI 正在生成时点击编辑器  | 高亮消失，但 AI 继续生成，生成完成后建议直接标记为失效 |
